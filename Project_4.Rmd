---
title: "mini Project - 1"
author: "Maxim Serdakov"
date: "07 03 2021"
output: html_document
---

```{r setup, include=FALSE}
library(survival)
library(survminer)
library(ranger)
library(ggplot2)
library(dplyr)
library(ggfortify)
library(coin)
```

## Данные и их структура. EDA 

Датасет содержит данные про выживаемость при рандомизированных сравнительных испытаниях двух лекарств от рака яичника:

- *futime*: время жизни или цензурирования данных 
- *fustat*: статус цензуры, 1 - цензурируются, 0 - нет 
- *age*: возраст в годах 
- *resid.ds*: присутствует ли болезнь остаточно, 1 - нет, 2 - да 
- *rx*: группа лечения 
- *ecog.ps*: статус эффективности 

```{r}
head(ovarian)
```

Оценим данные перед анализом. 

```{r}
str(ovarian)
```

Очевидно, что переменные остаточного статуса болезни, группы лечения и статуса эффективности, а так же статус цензуры, должны стать факторными переменными, а не численными. Будем помнить об этом в ходе анализа. 

Проверим, есть ли у нас неполные наблюдения, когда про пациента известно не все. Увидим, что в датасете нет неполных наблюдений. 

```{r}
sum(!complete.cases(ovarian))
```

## Кривые Каплана-Мeйера

Сначала оценим временной интервал, в рамках которого мы будем оценивать выживаемость. 

```{r}
km <- with(ovarian, Surv(futime, fustat))
head(km,80)
```

Далее построим линейную модель, которая учитывает изменение в выживаемости на основании фактора в зависимости от времени.

```{r}
km_fit <- survfit(Surv(futime, fustat) ~ 1, data=ovarian)
summary(km_fit, times = c(1,30,60,90*(1:10)))

autoplot(km_fit)
```

## Различия групп по выживаемости 

Оценим визуально влияние типа лечения на выживаемость. 

```{r}
km_trt_fit <- survfit(Surv(futime, fustat) ~ rx, data=ovarian)
autoplot(km_trt_fit, main = "Выживаемость во времени в зависимости от типа лечения")
```

Можно увидеть, что второе лечение обеспечивает бОльшую выживаемость в рамках конкретного промежутка времени, чем первое лечение, то есть второй тип лечения более эффективен. Однако, добавим еще один фактор - возраст, так как очевидно, выживаемость более старых людей будет снижена из-за естественных факторов независимо от лечения. 


```{r}
ov <- mutate(ovarian, AG = ifelse((age < 60), "LT60", "OV60"),
              AG = factor(AG),
              rx = factor(rx,labels=c("First","Second")),
              resid.ds = factor(resid.ds,labels=c("No","Yes")))

km_AG_fit <- survfit(Surv(futime, fustat) ~ AG, data=ov)
autoplot(km_AG_fit, main = "Выживаемость во времени в зависимости от возраста")
```

Видно, что действительно выживаемость людей, возраст которых больше 60, очевидно намного меньше, чем более молодых людей. Посмотрим теперь кривые выживаемости в зависимости от двух факторов - возраста и типа лечения. 

```{r}
ov_two_factors <- ov
ov_two_factors$hyb_fact <- paste(ov_two_factors$AG, ov_two_factors$rx)
km_AG_fit_tr <- survfit(Surv(futime, fustat) ~ hyb_fact, data=ov_two_factors)
autoplot(km_AG_fit_tr, main = "Выживаемость во времени в зависимости от возраста и типа лечения")
```

Очевидно, что внутри каждой из групп лечения, выживаемость лучше у более молодых пациентов, однако, тем не менее, видно, что внутри каждой из возрастных групп, второй тип лечения оказывается эффективнее первого. 

Посмотрим так же на то, как на выживаемость влияют другие факторные переменные из датасета. 

```{r echo=FALSE, message=FALSE, warning=FALSE}
km_resid_ds_fit <- survfit(Surv(futime, fustat) ~ resid.ds, data=ovarian)
autoplot(km_resid_ds_fit, main= "Выживаемость во времени в зависимости от остаточного статуса болезни")
```

Довольно очевидно, что если болезнь не присутствует остаточно, то выживаемость выше. 

```{r echo=FALSE, message=FALSE, warning=FALSE}
km_ecog_ps_fit <- survfit(Surv(futime, fustat) ~ ecog.ps, data=ovarian)
autoplot(km_ecog_ps_fit, main= "Выживаемость в зависимости от статуса эффективности")
```

В обшем и целом мы видим, что визуально группы по типу лечения, статусу эффективности и остаточному присутствию болезни отличаются по выживаемости. Однако, чтобы оценить это в полной мере, необходимо провести лог-ранк тесты. Сначала сделаем все факторные переменные действительно факторными:

```{r include=FALSE}
ovarian$resid.ds <- factor(ovarian$resid.ds, labels=c("No","Yes"))
ovarian$rx <- factor(ovarian$rx)
ovarian$ecog.ps <- factor(ovarian$ecog.ps)
```

И затем проведем тест, по которому поймем, действительно ли визуальное отличие кривых выживаемости для 1 и 2 типа лечения связано со значимыми отличиями в выживаемости между этими группами. 

```{r echo=FALSE}
survdiff(Surv(futime, fustat) ~ rx, data = ovarian)
```

Используем функцию logrank_test для точно численного ответа наличия различия в выживаемости между группами по лечению. 

```{r echo=FALSE}
logrank_test(Surv(futime, fustat) ~ rx, data = ovarian)
```

Видим, что значимых различий между группами на самом деле нет. Посмотрим на различия между другими факторными группами. Мы так же не обнаружим значимых различий для групп, разбитых по остаточному статусу болезни и статусу эффективности. 

```{r echo=FALSE}
logrank_test(Surv(futime, fustat) ~ resid.ds, data = ovarian)
```

```{r echo=FALSE}
logrank_test(Surv(futime, fustat) ~ ecog.ps, data = ovarian)
```

Однако, очевидно, есть значимые различия по выживаемости пациентов в зависимости от возраста. 

```{r echo=FALSE}
logrank_test(Surv(futime, fustat) ~ AG, data = ov)
```

И при этом, между нашими группами, разбитыми по 2 одновременно факторам, так же присутствуют значимые различия. 

```{r echo=FALSE}
ov_two_factors$hyb_fact <- factor(ov_two_factors$hyb_fact)
logrank_test(Surv(futime, fustat) ~ hyb_fact, data = ov_two_factors)
```

## Факторы, влияющие на риск 

Проанализируем факторы, влияющие на риск выживаемости, с помощью модели Кокса - по сути, просто будем строить линейную модель от наших переменных, но в качестве зависимой переменной будет выступать выживаемость. Сразу получим и описание модели, и ее визуализацию. 

```{r, message= FALSE}
cox <- coxph(Surv(futime, fustat) ~ rx + age + resid.ds + ecog.ps, data = ov)
summary(cox)

cox_fit <- survfit(cox)
autoplot(cox_fit)
```

Однако, этот график не очень наглядный для цели определения факторов, влияющих на риск, поэтому можем получить графики, которые позволят визуализировать влияние каждого фактора из модели на выживаемость. 

```{r, message=FALSE}
aa_fit <- aareg(Surv(futime, fustat) ~ rx + age + resid.ds + ecog.ps, data = ov)
autoplot(aa_fit)
```

Собственно оценить, какие именно факторы повышают риск события (выздоровления или нежелательного явления), используется отношение рисков (Hazard Ratio). Оно позволяет оценить вероятность того, что событие в одной группе случится раньше, чем в другой. Используемая формула выглядит как р=HR/(1+HR). 

```{r echo=FALSE, message=FALSE, warning=FALSE}
fit.coxph <- coxph(Surv(futime, fustat) ~ rx + AG + resid.ds + ecog.ps, data = ov)
ggforest(fit.coxph, data = ov)
```

По данным графикам мы можем сделать определенные выводы:

а) Пациенты, которые получали второй тип лечения, имеют меньший шанс смерти, нежели чем пациенты из группы, принимавшей лечение первого типа. То есть, несмотря на то, что значимых различий между группами (без добавления возраста как дополнительного фактора) мы не нашли, тем не менее, лечение второго типа снижает риск умереть относительно лечения первого типа. 
б) Очевидно, более молодые пациенты менее подвержены риску смерти. 
в) Пациенты, у которых болезнь присутствует остаточно, имеют сильно повышенный риск смерти. 
г) Пациенты со статусом ECOG = 2 так же более подвержены риску, чем пациенты из группы со статусом = 1. 